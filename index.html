<!DOCTYPE html>
<html>

<head>
    <title>Looting statistics</title>
    <meta name="author" content="Jacky Ly">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>

<style>
    html,
    body {
        font-family: Tahoma;
        font-size: 16px;
        text-align: center;
        scroll-behavior: smooth;
    }

    .button {
        border-radius: 8px;
        border: none;
        background-color: #56A5E1;
        color: white;
        font-family: Tahoma;
        font-size: 13px;
        text-align: center;
        padding: 10px 15px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #438cc3;
    }

    .nav {
        border: 1px solid #ccc;
        border-width: 1px 0;
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    .nav li {
        display: inline;
    }

    .nav a {
        display: inline-block;
        padding: 10px;
    }
</style>

<body onload="checkSettings();">
    <ul class="nav">
        <li><a href="https://crabada-resources.github.io/pure_sniping/">Pure Sniping</a></li>
        <li><a href="https://crabada-resources.github.io/should_i_buy/">Should I buy this crab?</a></li>
        <li><a href="https://crabada-resources.github.io/tavern_statistics/">Tavern Statistics</a></li>
    </ul>


    <div id="header">
        <h2>Looting revenue statistics</h2>
        <br></br>
        <form id="crabs_settings" onsubmit="return false">
            Enter your wallet ID: &nbsp;&nbsp; <input id="wallet" style="width: 20em" />
            <br></br>
            <button id="calculateBtn" class="button" onclick="calculate()">Calculate revenue</button>
        </form>



        <div id="results" style="display: none">
            <br></br>
            <h3> Results </h3>

            <p id="resuls_text"></p>
            <br>
            <div style="margin: auto;height:15vh; width:30vw">
                <canvas id="tus_revenue_chart"></canvas>
            </div>

        </div>
</body>
<script type="text/javascript">

    function checkSettings() {
        let wallet = document.getElementById("wallet");
        if (localStorage.getItem("wallet") != null) {
            wallet.setAttribute("value", localStorage.getItem("wallet"));
        }
        else {
            wallet.setAttribute("placeholder", "");
        }
    }

    function calculate() {
        clearForm()
        let wallet = document.getElementById("wallet").value;
        const totalByDay = {}
        const totalByTeam = {}
        let totalTUS = 0
        let totalCRA = 0
        let totalLoots = 0
        let totalWins = 0
        let totalLosses = 0
        fetch(`https://idle-api.crabada.com/public/idle/mines?looter_address=${wallet}&status=close&limit=1000`).then(response => response.json())
            .then(function (response) {
                const loots = response["result"]["data"]
                loots.forEach(t => {

                    const looter_cra_reward = t.looter_cra_reward
                    const looter_tus_reward = t.looter_tus_reward
                    const date = new Date(t.end_time * 1000)
                    const day = date.toISOString().split('T')[0]
                    if (!(day in totalByDay)) {
                        totalByDay[day] = {}
                        totalByDay[day].cra = 0
                        totalByDay[day].tus = 0
                        totalByDay[day].loots = 0
                        totalByDay[day].wins = 0
                        totalByDay[day].losses = 0
                    }
                    totalByDay[day].cra += looter_cra_reward
                    totalByDay[day].tus += looter_tus_reward
                    totalByDay[day].loots += 1
                    totalTUS += looter_tus_reward
                    totalCRA += looter_cra_reward
                    totalLoots += 1
                    if (t.attack_team_id == t.winner_team_id) {
                        totalWins += 1
                        totalByDay[day].wins += 1

                    } else {
                        totalLosses += 1
                        totalByDay[day].losses += 1
                    }

                })

                localStorage.setItem("wallet", wallet);
                let results = document.getElementById("results");
                results.style.display = "block";

                dailyAvgTUS = totalTUS / Object.keys(totalByDay).length
                dailyAvgCRA = totalCRA / Object.keys(totalByDay).length
                dailyAvgLoots = totalLoots / Object.keys(totalByDay).length
                dailyAvgWins = totalWins / Object.keys(totalByDay).length
                dailyAvgLosses = totalLosses / Object.keys(totalByDay).length

                dailyMax = Object.keys(totalByDay).reduce(function (a, b) { return totalByDay[a].tus > totalByDay[b].tus ? a : b });



                let resuls_text = document.getElementById("resuls_text");
                resuls_text.innerHTML = `Total revenue: ${(totalTUS / 1.0e18).toFixed(4)} TUS and ${(totalCRA / 1.0e18).toFixed(4)} CRA</br>`
                resuls_text.innerHTML += `Average revenue per day: ${(dailyAvgTUS / 1.0e18).toFixed(4)} TUS and ${(dailyAvgCRA / 1.0e18).toFixed(4)} CRA</br>`;
                resuls_text.innerHTML += `Best day: ${(totalByDay[dailyMax].tus / 1.0e18).toFixed(4)} TUS and ${(totalByDay[dailyMax].cra / 1.0e18).toFixed(4)} CRA (${dailyMax} - ${totalByDay[dailyMax].loots} loots)</br>`;
                resuls_text.innerHTML += `Total loots: ${totalLoots} being ${totalWins} wins and ${totalLosses} losses (${Math.round(100 * totalWins / (totalLoots))}% win rate)</br>`;
                resuls_text.innerHTML += `Average loots per day: ${dailyAvgLoots.toFixed(1)} being on average ${dailyAvgWins.toFixed(1)} wins and ${dailyAvgLosses.toFixed(1)} losses (${Math.round(100 * dailyAvgWins / (dailyAvgLoots))}% win rate)</br>`;

                resuls_text.innerHTML += `</br>Daily stats:</br>`

                const labels = []
                const data_values = []
                Object.keys(totalByDay).sort(function (a, b) {
                    return moment(b, 'YYYY-MM-DD').toDate() - moment(a, 'YYYY-MM-DD').toDate();
                }).reverse().forEach(function (key) {
                    labels.push(key)
                    data_values.push((totalByDay[key].tus / 1.0e18).toFixed(4))
                    resuls_text.innerHTML += `${key} - ${(totalByDay[key].tus / 1.0e18).toFixed(4)} TUS - ${(totalByDay[key].cra / 1.0e18).toFixed(4)} CRA - ${totalByDay[key].loots} loots (${Math.round(100 * totalByDay[key].wins / (totalByDay[key].loots))}% win rate)</br>`;
                })

                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'TUS Revenue per day',
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: data_values,
                    }]
                };
                var chart = new Chart(document.getElementById('tus_revenue_chart').getContext('2d'),
                    {
                        type: 'line',
                        data: data,
                        options: {
                        }
                    });


            }).catch(function (error) {
                console.log(error);
            });
    }

    function clearForm() {
        let resuls_text = document.getElementById("resuls_text");
        let results = document.getElementById("results");

        resuls_text.innerHTML = "";
        results.style.display = "none";
    }

</script>

</html>